<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <title>Terminal de Expurgo Aurora - CTF</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        /* ... (Estilos CSS omitidos para brevidade, mas estão no seu código) ... */
    </style>
</head>
<body>
    <canvas class="matrix"></canvas>
    <div class="terminal-box">
        <h2>Terminal de Expurgo<br>Aurora</h2>
        <p>
            Eu não tenho voz, mas reverbero em todos os sistemas.<br>
            Eu não tenho corpo, mas sou a fundação da liberdade e do caos.<br>
            O Sindicato me serve, mas eu não sirvo a ninguém.<br><br>
            <b>O que eu sou?</b>
        </p>
        <form id="ctfform" method="POST" autocomplete="off" novalidate>
            <div id="inicio">
                <input name="resposta" id="resposta" maxlength="60" placeholder="Digite sua resposta aqui..." required>
                <button type="submit" id="submitBtn">Enviar resposta</button>
            </div>
            <div id="expurgo" style="display:none;">
                <div class="message" style="margin-bottom:9px;">
                    A senha-mestra para o script de expurgo é a memória da minha recuperação.
                </div>
                <input name="telefone" id="telefone" maxlength="20" placeholder="Seu telefone (DDD+número)">
                <input name="email" id="email" type="email" maxlength="64" placeholder="Seu melhor e-mail">
                <input name="expurgo" id="expurgoInput" maxlength="30" placeholder="Senha-mestra final">
                <button type="submit" id="expurgoBtn">Executar comando de expurgo</button>
            </div>
        </form>
        <div class="message" id="msg"></div>
    </div>
    <script>
        // Matrix rain effect (mantido)
        const c = document.querySelector('canvas.matrix');
        const ctx = c.getContext('2d');
        function resizeMatrixCanvas() {
            c.width = window.innerWidth;
            c.height = window.innerHeight;
        }
        resizeMatrixCanvas();
        let fontSize = Math.max(Math.min(window.innerWidth / 24, 22), 12);
        let columns = Math.floor(c.width / fontSize);
        let drops = Array(columns).fill(1);
        function drawMatrix() {
            ctx.fillStyle = "rgba(11, 24, 9, 0.18)";
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.font = fontSize + "px Share Tech Mono, monospace";
            ctx.fillStyle = "#38ff21";
            for(let i = 0; i < drops.length; i++) {
                const txt = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&"[Math.floor(Math.random()*69)];
                ctx.fillText(txt, i*fontSize, drops[i]*fontSize);
                if(drops[i]*fontSize > c.height && Math.random() > 0.96) drops[i] = 0;
                drops[i]++;
            }
        }
        setInterval(drawMatrix, 53);
        window.addEventListener('resize', () => {
            resizeMatrixCanvas();
            fontSize = Math.max(Math.min(window.innerWidth / 24, 22), 12);
            columns = Math.floor(c.width / fontSize);
            drops = Array(columns).fill(1);
        });

        // --- Lógica de Submissão para a Vercel ---
        const API_URL = 'https://ctfporteira.vercel.app'; 

        document.getElementById('ctfform').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const messageDiv = document.getElementById('msg');
            messageDiv.textContent = 'Processando...';
            messageDiv.style.color = '#fffdc2'; 

            const resposta = document.getElementById('resposta').value.trim().toUpperCase();
            
            const inicioDiv = document.getElementById('inicio');
            const expurgoDiv = document.getElementById('expurgo');

            // **PASSO 1: Lógica de Transição de Tela (CODIGO)**
            if (inicioDiv.style.display !== "none" && resposta === "CODIGO") {
                inicioDiv.style.display = "none";
                expurgoDiv.style.display = "flex";
                document.getElementById('telefone').required = true;
                document.getElementById('email').required = true;
                document.getElementById('expurgoInput').required = true;
                document.getElementById('telefone').focus();
                messageDiv.textContent = "Chave reconhecida! Digite seus dados e a senha-mestra final para expulsar o invasor.";
                messageDiv.style.color = '#36ff21'; 
                return;
            }

            // **PASSO 2: Envio Final para a Vercel (CACHE)**
            if (expurgoDiv.style.display !== "none") {
                try {
                    const response = await fetch(API_URL + '/api/submit-terminal', {
                        method: 'POST',
                        body: new FormData(form),
                    });
                    
                    const result = await response.json();

                    if (result.success) {
                        messageDiv.textContent = 'SUCESSO! ' + result.message;
                        messageDiv.style.color = '#36ff21'; 
                    } else {
                        messageDiv.textContent = 'ERRO: ' + result.message;
                        messageDiv.style.color = '#ff4141'; 
                    }
                } catch (error) {
                    messageDiv.textContent = 'Erro de rede ou servidor. Verifique a conexão.';
                    messageDiv.style.color = '#ff4141';
                    console.error('Fetch Error:', error);
                }
            } else {
                // Se a resposta inicial não era CODIGO
                messageDiv.textContent = "Resposta incorreta, tente novamente.";
                messageDiv.style.color = '#ff4141';
            }
        });
    </script>
</body>
</html>

